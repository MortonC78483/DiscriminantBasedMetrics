---
title: "make_figures"
author: "Claire Morton"
date: "5/16/2024"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(ipumsr)
library(srvyr)
library(tidysynthesis)
library(parsnip)
library("data.table")
library(recipes)
library(devtools)
#load_all('../syntheval')
library(syntheval)
library(dials)
library(tune)
library(gtools)
library(MASS)
library(caret)
library(gt)
library(ggpubr)
library(patchwork)
library(wesanderson)
library(ggplot2)
library(gridExtra)

set.seed(78483)
```

## Function for Figure 1, 2, S1, S2
```{r fig12s1s2_funcs}
make_boxplot_fig <- function(df, level_order, group_colors, type, metric, name) {
  
  # take out lasso for pMSE-ratio
  df$pmse_ratio_test <- log10(df$pmse_ratio_test)
  df$pmse_ratio_train <- log10(df$pmse_ratio_train)
  df$pmse_ratio_test[df$type == "lasso"] <- 0
  df$pmse_ratio_train[df$type == "lasso"] <- 0
  
  df$type <- as.factor(df$type)
  levels(df$type) <- c("LASSO", "Logistic Regression", "Random Forest", "Classification Tree")
  df$type <- ordered(df$type, levels = c("LASSO", "Logistic Regression", "Random Forest", "Classification Tree"))
  
  pal <- wes_palette("AsteroidCity1", n = 4)

  colors <- rep(pal, 4)
  if (metric == "pmse_ratio"){
    colors[1] = "white"
    colors[5] = "white"
    colors[9] = "white"
    colors[13] = "white"
  }
  
  y_var <- paste0(metric, "_", type)  # e.g., "specks_train" or "pmse_train"
  y_label <- paste0(name)

  plot <- ggplot(df, aes(x = "", 
                 group = type, 
                 y = as.numeric(get(y_var)),
                 color = type)) +
    geom_boxplot() +
    ylab(y_label) +
    xlab("") +
    labs(color = "Model Type") +
    scale_color_manual(values = colors)+
    theme_classic() +
    facet_wrap(facet = vars(factor(name, level = level_order)), nrow = 1)+
    theme(legend.position = 'right')
   plot
}

make_boxplot_arr <- function(df, type){
  level_order <- c("Control", "Mean", "Correlation", "All") 
  fig_a = make_boxplot_fig(df, level_order, group_colors, type = type, metric = "specks", name = "SPECKS")+
    ylim(0,1)
  legend_a = get_legend(fig_a)
  fig_b = make_boxplot_fig(df, level_order, group_colors, type = type, metric = "pmse", name = "pMSE")+
    ylim(0,.25)
  fig_c = make_boxplot_fig(df, level_order, group_colors, type = type, metric = "auc", name = "AUC")+
    ylim(0,1)
  fig_d = make_boxplot_fig(df, level_order, group_colors, type = type, metric = "pmse_ratio", name = "log(pMSE-ratio)")
  
  fig_a <- fig_a + theme(legend.position = "none")
  fig_b <- fig_b + theme(legend.position = "none")
  fig_c <- fig_c + theme(legend.position = "none")
  fig_d <- fig_d + theme(legend.position = "none")
  
  return(ggarrange(arrangeGrob(fig_a, fig_b, fig_c, fig_d, ncol = 1), legend_a, ncol = 2, widths=c(5, 1.5)))

}
```

## Figure S1, 1
Uses output from model_comparison2.qmd (fig1_v2.csv) which has train/test for 10 models.
```{r figs1}
# indicates control (synthetic and confidential data from same distribution), errors with both mean and variance, 
# errors with correlations, and errors with means
df <- read.csv("data/fig1.csv")

combined_plot <- make_boxplot_arr(df, "train")
ggsave("figures/fig_s1.pdf", plot = combined_plot, width = 7, height = 10)
ggsave("figures/fig_s1.png", plot = combined_plot, width = 7, height = 10)

combined_plot <- make_boxplot_arr(df, "test")
ggsave("figures/fig_1.pdf", plot = combined_plot, width = 7, height = 10)
ggsave("figures/fig_1.png", plot = combined_plot, width = 7, height = 10)
```

## Figs S2, 2
```{r figs2}
df <- read.csv("data/fig2.csv")

combined_plot <- make_boxplot_arr(df, "train")
ggsave("figures/fig_s2.pdf", plot = combined_plot, width = 7, height = 10)
ggsave("figures/fig_s2.png", plot = combined_plot, width = 7, height = 10)

combined_plot <- make_boxplot_arr(df, "test")
ggsave("figures/fig_2.pdf", plot = combined_plot, width = 7, height = 10)
ggsave("figures/fig_2.png", plot = combined_plot, width = 7, height = 10)
```

```{r fig3456_func}
make_fig3456 <- function(df, metric, name, group){
  pal <- wes_palette("AsteroidCity1", n = 2)
  
  if (group == "pov"){
    df$synth_type = factor(df$synth_type, levels = c("nopov_bad", "nopov_med", "good", "pov_med", "pov_bad"))
    plot <- ggplot(df, aes(x = synth_type, y = .data[[name]], color = pov_class))+
      geom_point(alpha = .5)+
      ylab(metric)+
      xlab("Synthesis Type")+
      theme_classic()+
      scale_x_discrete(labels = c("Over-poor", "Over-fair", "Poverty-good", "Under-fair", "Under-poor"))+
      scale_color_discrete(name = "Group", labels = c("Over", "Under"), type = pal)
  }
  else if (group == "race"){
    df$black_class <- factor(df$black_class, levels = c("noblack", "black"))
    df$synth_type = factor(df$synth_type, levels = c("noBLACK_bad", "noBLACK_med", "good", "BLACK_med", "BLACK_bad"))
    plot <- ggplot(df, aes(x = synth_type, y =.data[[name]], color =black_class))+
      geom_point(alpha = .5)+
      ylab(metric)+
      xlab("Synthesis Type")+
      theme_classic()+
      scale_x_discrete(labels = c("White-poor", "White-fair", "Race-good", "Black-fair", "Black-poor"))+
      scale_color_discrete(name = "Group", labels = c("White", "Black"), type = pal)
  }
  return(plot)
}
```

```{r fig_35}
#Plot results
one_model_df <- read.csv("data/one_model_df_pov.csv")
two_model_df <- read.csv("data/two_model_df_pov.csv")

one_model_df$pmse_ratios <- log10(one_model_df$pmse_ratios)
two_model_df$pmse_ratios <- log10(two_model_df$pmse_ratios)

one_auc <- make_fig3456(one_model_df, metric = "AUC", name = "aucs", group = "pov")
one_specks <- make_fig3456(one_model_df, metric = "SPECKS", name = "speckss", group = "pov")
one_pmse <- make_fig3456(one_model_df, metric = "pMSE", name = "pmses", group = "pov")
one_pmse_ratio <- make_fig3456(one_model_df, metric = "log(pMSE-ratio)", name = "pmse_ratios", group = "pov")

two_auc <- make_fig3456(two_model_df, metric = "AUC", name = "aucs", group = "pov")
two_specks <- make_fig3456(two_model_df, metric = "SPECKS", name = "speckss", group = "pov")
two_pmse <- make_fig3456(two_model_df, metric = "pMSE", name = "pmses", group = "pov")
two_pmse_ratio <- make_fig3456(two_model_df, metric = "log(pMSE-ratio)", name = "pmse_ratios", group = "pov")

combined_plot <- (one_auc + theme(legend.position = "none")) +
                  (one_specks + theme(legend.position = "none")) +
                  (one_pmse + theme(legend.position = "none")) +
                  (one_pmse_ratio + theme(legend.position = "none")) +
                 plot_layout(guides = 'collect') &
                 theme(legend.position = "right")

ggsave("figures/fig_3.pdf", plot = combined_plot, width = 10, height = 8)
ggsave("figures/fig_3.png", plot = combined_plot, width = 10, height = 8)

combined_plot <- (two_auc + theme(legend.position = "none")) +
                 (two_specks + theme(legend.position = "none")) +
                  (two_pmse + theme(legend.position = "none")) +
                (two_pmse_ratio + theme(legend.position = "none")) +
                 plot_layout(guides = 'collect') &
                 theme(legend.position = "right")

ggsave("figures/fig_5.pdf", plot = combined_plot, width = 10, height = 8)
ggsave("figures/fig_5.png", plot = combined_plot, width = 10, height = 8)
```

```{r fig_46}
#Plot results

one_model_df <- read.csv("data/one_model_df_black.csv")
two_model_df <- read.csv("data/two_model_df_black.csv")

one_model_df$pmse_ratios <- log10(one_model_df$pmse_ratios)
two_model_df$pmse_ratios <- log10(two_model_df$pmse_ratios)

one_auc <- make_fig3456(one_model_df, metric = "AUC", name = "aucs", group = "race")
one_specks <- make_fig3456(one_model_df, metric = "SPECKS", name = "speckss", group = "race")
one_pmse <- make_fig3456(one_model_df, metric = "pMSE", name = "pmses", group = "race")
one_pmse_ratio <- make_fig3456(one_model_df, metric = "log(pMSE-ratio)", name = "pmse_ratios", group = "race")

two_auc <- make_fig3456(two_model_df, metric = "AUC", name = "aucs", group = "race")
two_specks <- make_fig3456(two_model_df, metric = "SPECKS", name = "speckss", group = "race")
two_pmse <- make_fig3456(two_model_df, metric = "pMSE", name = "pmses", group = "race")
two_pmse_ratio <- make_fig3456(two_model_df, metric = "log(pMSE-ratio)", name = "pmse_ratios", group = "race")

combined_plot <- (one_auc + theme(legend.position = "none")) +
                  (one_specks + theme(legend.position = "none")) +
                  (one_pmse + theme(legend.position = "none")) +
                  (one_pmse_ratio + theme(legend.position = "none")) +
                 plot_layout(guides = 'collect') &
                 theme(legend.position = "right")
ggsave("figures/fig_4.pdf", plot = combined_plot, width = 10, height = 8)
ggsave("figures/fig_4.png", plot = combined_plot, width = 10, height = 8)

combined_plot <- (two_auc + theme(legend.position = "none")) +
                  (two_specks + theme(legend.position = "none")) +
                  (two_pmse + theme(legend.position = "none")) +
                  (two_pmse_ratio + theme(legend.position = "none")) +
                 plot_layout(guides = 'collect') &
                 theme(legend.position = "right")
ggsave("figures/fig_6.pdf", plot = combined_plot, width = 10, height = 8)
ggsave("figures/fig_6.png", plot = combined_plot, width = 10, height = 8)
```

